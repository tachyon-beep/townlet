# WP-D Telemetry Refactor – Planning Notes

## Phase 0 Baselines
- Simulation baseline: `python scripts/run_simulation.py configs/examples/poc_hybrid.yaml --ticks 200 --telemetry-path tmp/wp-d/phase0_baseline.jsonl` emitted 168 buffer-drop warnings (`Telemetry buffer exceeded 256000 bytes; dropped N payloads`). File saved at `tmp/wp-d/phase0_baseline.jsonl`.
- Targeted telemetry suites executed via `pytest tests/test_telemetry_transport.py tests/test_telemetry_worker_health.py tests/test_telemetry_stream_smoke.py -q`; log captured in `tmp/wp-d/phase0_test_logs/telemetry_tests.log`. (Legacy filenames from original brief were unavailable, so nearest coverage set was used.)
- Worker profile snapshot generated by inline harness (`SimulationLoop.run_for(50)`); metrics stored in `tmp/wp-d/phase0_profile_metrics.json`:
  - `queue_length`: 45
  - `dropped_messages`: 0
  - `worker_alive`: true
  - `worker_restart_count`: 0
  - `worker_thread_count`: 1 (thread name prefix `telemetry-flush`)
  - `threads_total`: 2
  - `cpu_user_seconds`: 1.94, `cpu_system_seconds`: 0.10

## Consumer Inventory (TelemetryPublisher)
| Category | Module | Usage Notes |
| --- | --- | --- |
| Runtime | `src/townlet/core/factory_registry.py` | Instantiates concrete `TelemetryPublisher` inside registry lambdas; primary factory binding. |
| Runtime | `src/townlet/telemetry/__init__.py` | Re-exports class for external imports. |
| Runtime | `tests/test_observer_payload.py`, `tests/test_snapshot_manager.py` | Access `loop.telemetry` and import the class directly for fixtures and round-trip verification. |
| Runtime | `tests/test_console_auth.py`, `tests/test_console_events.py` | Instantiate publisher to validate console authentication/command batching behaviour. |
| Runtime | `tests/test_embedding_allocator.py` | Uses publisher to prime embedding metrics. |
| Runtime | `tests/test_conflict_telemetry.py`, `tests/test_telemetry_narration.py`, `tests/test_telemetry_worker_health.py`, `tests/test_telemetry_transport.py` | Direct instantiation to inspect queue analytics, narration throttling, worker restarts, transport factory behaviour. |
| Observability | `tests/test_affordance_manifest.py`, `tests/test_core_protocols.py` | Verify export/import contract and protocol satisfaction. |
| Documentation | `audit/MODULE_DOCUMENTATION.md`, `audit/module_metadata.json` | Reference entries that will require regeneration after refactor. |

Additional grep highlights show console handlers, scheduler, demo runner, UI gateway, and CLI scripts referencing telemetry via the simulation loop/factories; these will migrate during Phase 6.

## Event & Payload Schema Notes

`TelemetryPublisher.export_state()` emits a canonical snapshot with the following top-level keys (all optional unless noted):
- `queue_metrics` (`dict[str, int]`): cooldown/ghost/rotation counters.
- `embedding_metrics` (`dict[str, float]`): allocator utilisation.
- `conflict_snapshot` (`dict`): queue conflict totals plus history.
- `relationship_metrics`, `relationship_summary`, `relationship_snapshot`, `relationship_updates`, `relationship_overlay`.
- `job_snapshot`, `employment_metrics`, `economy_snapshot`, `economy_settings`, `price_spikes`, `utilities`.
- `affordance_runtime` (`running`, `running_count`, `active_reservations`, `event_counts`).
- `narrations`, `narration_state`, `events` (console + social event payloads), `social_events`.
- `reward_breakdown`, `perturbations`, `policy_snapshot`, `policy_identity`, `anneal_status`.
- `kpi_history` (lists of floats/ints per KPI), `snapshot_migrations` (list[str]).
- `transport_status` (connection flags, queue length, worker health metrics) plus `transport_buffer_pending`.
- `health` (loop heartbeat), `queue_history`, `rivalry_events`, `console_results`, `possessed_agents`, `precondition_failures`, `promotion_state`.

`_build_stream_payload()` composes snapshot payloads with `payload_type: "snapshot"` on first emission and `payload_type: "diff"` thereafter, using `_build_diff_payload()` to populate `changes` and optional `removed` sections. Narration payloads rely on constants exported from `townlet.telemetry.events` (`relationship_friendship`, `relationship_rivalry`, `relationship_social_alert`) and include `agent`, `target`, `delta`, `reason`, and summarised history fields. Console audit payloads (`_append_console_audit`) capture `command`, `issuer`, `result`, and timestamps.

## Failure Mode Review (Preliminary)
- `_flush_loop` / `_send_with_retry` (src/townlet/telemetry/publisher.py:521-654): payloads flush on a fixed interval with retries controlled by `config.telemetry.transport.retry`. Buffer backpressure is binary—once `TransportBuffer` exceeds `max_buffer_bytes` payloads are dropped (`logger.warning` triggered repeatedly in Phase 0 baseline). There is no dynamic throttling or batching beyond `max_batch_size`.
- `_start_flush_thread` and restart logic (lines ~122-170): worker restarts limited to `self._worker_restart_limit == 3`; race window exists if `close()` flips `_shutdown` while `_pending_restart` is true (locks shared across `_worker_state_lock`, `_worker_restart_lock`).
- No existing test markers explicitly flag telemetry concurrency as flaky (`rg "TODO" -g'test_telemetry_*' tests` returned none). Historical concerns surface as comments inside `tests/test_telemetry_worker_health.py` which monkeypatch thread joins to avoid hangs; note for mitigation design.
- Docstring coverage (`python -m interrogate -vv --fail-under 0 src/townlet/telemetry`): 30.0% callable coverage (119 missing docstrings). Results stored in `tmp/wp-d/phase0_docstrings.txt`.
- Type-check baseline (`mypy src/townlet/telemetry`): 57 errors across 4 files, concentrated in `relationship_metrics.py` (loose `object` typing), `transport.py` (socket lifecycle), and `publisher.py` (diff payload coercion). Full output recorded in `tmp/wp-d/phase0_mypy.txt`.

Planned mitigations: introduce configurable backpressure strategy (drop oldest vs block), centralise worker supervision to eliminate restart races, design transform layer to reduce diff payload volume, and provide typed helper adapters to eliminate `object` casts flagged by mypy.

## Phase 1 – Architecture Blueprint

### Layered Pipeline Overview
```
SimulationLoop.publish_tick()
         |
         v
+---------------------------+
| TelemetryAggregation
|  (collect_tick, console)
+---------------------------+
         |
         v
+---------------------------+
| TelemetryTransform
|  (process -> filter/enrich)
+---------------------------+
         |
         v
+---------------------------+
| TelemetryTransport
|  (start/send/flush/close)
+---------------------------+
         |
         v
External sink(s) / files / streams
```
- Aggregation consumes world state + per-tick artefacts, returning `TelemetryEvent` batches.
- Transforms run sequentially; each may drop or mutate events and expose a `flush()` hook for diff batching.
- Transport receives already-normalised events; concurrency/backpressure will be managed by the Phase 5 worker manager.
- Console ingress stays within aggregation, letting `SimulationLoop` interact solely via `TelemetrySinkProtocol`.

### Walkthrough Notes (2024-05-13 virtual review)
- Attendees: World runtime (A. Reyes), Policy (M. Hargrove), Telemetry owner (J. Patel).
- Consensus: keep world snapshot assembly inside aggregation to avoid cyclic dependencies; transforms host diff builder + schema validator.
- Policy requested explicit hook for policy snapshot diffing—captured via `TelemetryEvent(kind="snapshot", metadata={"policy_hash": ...})`.
- Health heartbeat must emit even when no other payloads trigger (`kind="health"` events from aggregation).
- Action items: document default transform stack, note worker ownership split, confirm console auth metrics remain exposed via aggregation metadata.

### Acceptance Criteria (Phase 1 sign-off)
- Interfaces merged (`src/townlet/telemetry/interfaces.py`) with runtime-checkable protocols and `TelemetryEvent` dataclass.
- Plan doc updated with pipeline diagram, walkthrough notes, and success metrics.
- Targets for later phases:
  * Telemetry transport flush p95 latency < 250 ms using default file transport over 1k tick run.
  * Backpressure: zero buffer drops with default configuration; drop-oldest strategy documented for constrained environments.
  * Schema parity checklist maintained (Phase 0 baseline keys vs aggregation outputs, diff verified before Phase 5).
  * Health events emitted every tick; worker restarts remain < 3 without manual intervention.
- Sign-off gate: review stakeholders acknowledge plan in doc (✅ to be marked during review session).

## Phase 2 – Aggregation Layer Extraction (in progress)

- Step A delivered a standalone `StreamPayloadBuilder` and helper utilities under `src/townlet/telemetry/aggregation/`.
- Step B introduces `TelemetryAggregator`, now instantiated by `TelemetryPublisher`; `publish_tick` delegates payload emission through the aggregation adapter while legacy methods (`record_console_results`, `record_loop_failure`) wrap thin shims that call into the adapter sinks. Targeted telemetry, console, and snapshot tests still pass (`pytest tests/test_telemetry_stream_smoke.py ...`).
- Step C adds dedicated unit tests (`tests/telemetry/test_aggregation.py`) validating snapshot construction, diff emission, console sinks, and loop-failure events.

## Phase 3 – Transform Layer Implementation (in progress)

- Extracted normalization helpers into `src/townlet/telemetry/transform/normalizers.py` and introduced `TelemetryTransformPipeline` (`src/townlet/telemetry/transform/pipeline.py`).
- Added configurable transform implementations (`RedactFieldsTransform`, `EnsureFieldsTransform`) under `src/townlet/telemetry/transform/transforms.py` with publisher wiring.
- Telemetry configuration now accepts `telemetry.transforms.pipeline`, enabling deployments to override the default snapshot/redaction/validation stack.
- Schema validation transform available (`schema_validator`), supporting JSON Schema checks with configurable failure modes.

## Phase 4 – Transport Layer & Adapters (in progress)

- Step A: Introduced lifecycle-aware `StdoutTransport`, `FileTransport`, `TcpTransport`, plus a stub `WebsocketTransport`; publisher now manages transport start/stop explicitly.
- Step B: Config loader accepts `type: websocket` with `websocket_url`; CLI `run_simulation` honours config transport selection without additional overrides.
